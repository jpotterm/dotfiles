<?
-- This page uses generic_header.xml.

-- These functions originally from boxmodel_start_page.xml
function printgenres(genres)
  for i,g in ipairs(genres) do
    if i ~= 1 then print(", ") end
    %><link url="${searchuri(g,"genre")}">${g}</link><%
  end
end
function printyears(years)
  i = 0
  for word in string.gmatch(years, "%S+") do
  if i ~= 0 then print ", " end
    i = i + 1
    if word:sub(-1) == ',' then word = word:sub(1, -2) end
    w = word
    if w:sub(-1) == 's' then
      v = tonumber(w:sub(1,2)) + 1900
      if v == 1900 then v = v + 100 end
      w = string.format("%d-%d", v, v+9)
    else
      if w:sub(1,1) == '-' then w = "1900" .. w end
      if w:sub(-1) == '-' then w = w .. "2099" end
    end
    %><link url="${searchuri(w,"year")}">${word}</link><%
  end
end

years_active = function()
?>
${printyears(data.years)}
<?
end

-- Replace <a href> with <link url>
biography = function()
  if data.text_is_xml then
    text, matches = string.gsub(data.text, "<a href=\"([^\"]*)\">([^<]*)</a>", "<link url=\"%1\">%2</link>")
    print(text)
  else
    printexp(data.text)
  end
end

related_artists = function()
?>
<style>
  imageRelated {
    width: 60;
    height: 60;
    image-mode: cutout;
  }
  textRelated {
    textDescription;
    link-color:#ccc;
    hoverlink-color:#fff;
    hoverlink-underline:1;
  }
</style>
<vbox flex="66">
  <!--
  Texts can't be clickable, and they set the cursor shape above them themselves, if they're on top.
  The boxes below are a slightly hacky workaround.
  With proper links to tabs, this would not be a problem.
  -->
  <box>
    <text style="textTitle">@{Related artists title}</text>
    <box style="cursor:hand" onclick="related_artists" />
  </box>
  <!-- End of workaround. -->
  <flow height="60" colspacing="0" rowspacing="0" maxlines="1" margin="0,4,0,4">
  % for i, artist in ipairs(data.related_artists) do
    <link url="${artist.link}">
      <img style="imageRelated" src="${artist.image}" alt="PlaceholderArtist|60" />
    </link>
  % end
  </flow>
  <text style="textRelated" maxlines="2"><?
  for i, artist in ipairs(data.related_artists) do
    if i ~= 1 then
      print(" â€¢ ")
    end
    ?><link url="${artist.link}">${artist.name}</link><?
  end
  ?></text>
</vbox>
<?
end

template = {
  image = data.image,
  image_alt = "PlaceholderArtist|128",
  image_link = data.link,
  title = data.name,
  title_link = data.link,
  stats = years_active,
  description = biography,
  offline_available = data.playlist_offline_available,
  offline = data.is_offline,
  title_items = {
    "standard_title",
    "filler",
    "stats",
  },
  toolbar_items = {
    "share",
    "artist_radio",
    "filler",
  },
  right_items = {
  }
}

if data.related_artists then
  table.insert(template.right_items, related_artists)
end

include("views/generic_header.xml")

?>
